---
title: "Agriculture in Pakistan"
output:
    pdf_document: default
    html_document: default
---

```{r, echo=FALSE, message=FALSE, results='hide'}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

library(tidyverse)
library(patchwork)
library(ggthemes)
library(knitr)
library(broom)
library(haven)

base_year = 2019

df_full <- read_stata("data/DEV309_FullDataset_2019.dta")

# Global data
yields_global   <- read_csv("data/yields-global.csv")
volumes_global  <- read_csv("data/volumes-global.csv")

values_global   <- read_csv("data/values-global.csv")

production_all  <- read_csv("data/production-crops-all-normalized.csv") # this makes yields and volumes all redundant

country_codes <- read_csv("data/wikipedia-iso-country-codes.csv")

cc_map <- country_codes %>%
    select(`Alpha-3 code`, `English short name lower case`, `Numeric code`)

production_global <- production_all %>% 
    select(Year, Area, `Area Code (M49)`, `Item Code`, Item, Element, Unit, Value) %>%
    filter(Unit %in% c("ha", "hg/ha", "tonnes"))

values_global_minimal <- values_global %>%
    select(Year, `Area Code (M49)`, Area, `Item Code` = `Item Code (FAO)`, Item, Element, Unit, Value)

global_agri_data <- rbind(production_global, values_global_minimal) %>%
    mutate(
           `Area Code` = str_replace(`Area Code (M49)`, "'", "")
    ) %>%
    select(-`Area Code (M49)`) %>%
    left_join(cc_map, by=c("Area Code" = "Numeric code")) %>%
    rename(
           "countrycode" = "Alpha-3 code",
           "year" = "Year"
    ) %>%
    select(-"English short name lower case")

global_agri_wide <- global_agri_data %>%
    select(-Unit) %>%
    filter(year >= 1991) %>%
    pivot_wider(names_from="Element", values_from="Value") %>%
    rename(`Gross Production Value` = `Gross Production Value (constant 2014-2016 thousand US$)`) %>%
    mutate(
           `Gross Production Value` = `Gross Production Value` * 1000,
           econ_yield = `Gross Production Value` / `Area harvested`,
           price = `Gross Production Value` / Production
    )

# TODO: better list of comparators
# comparators <- (df_full %>% 
#     filter(regionname == "South Asia") %>% 
#     filter(countrycode != "MDV") %>%
#     select(countrycode) %>% 
#     unique())$countrycode

comparators <- c("PAK", "AFG", "BGD", "BTN", "IND", "LKA", "NPL") 
                 # "VNM", "EGY", "IDN", "MAR", "MMR", "PHL")

```

## Metrics Used

We use the following indicators to generate our metrics

\textbf{Value Added in Agriculture, constant 2010 US\$}: The net output of the Agriculture sector, including forestry hunting and fishing, after adding up all outputs and subtracting intermediate inputs. It is calculated without making deductions for depreciations of fabricated assets or depletion and degradation of natural resources. 

\textbf{Employment in Agriculture (\% of total employment) (modeled ILO estimate)}: Employment is defined as persons of working age who were engaged in any activity to produce goods or produce services for pay or profit, whether at work during the reference period or not at work due to temporary absence from a job, or to working-time arrangement. The agriculture sector consists of activities in agriculture, hunting, forestry and fishing

\textbf{Working Age Population}: Total population between the ages 15 to 64. 

\textbf{Arable Land}: Arable land (in hectares) includes land defined by the FAO as land under temporary crops (double-cropped areas are counted once), temporary meadows for mowing or for pasture, land under market or kitchen gardens, and land temporarily fallow. Land abandoned as a result of shifting cultivation is excluded. 

## Pakistan have low Value Added per Worker in Agriculture?

For it's level of GDP per Capita, Pakistan has a slightly above-expected valued added per worker in agriculture. 

```{r fig.height=10, fig.width=10}

inds <- c(
          "Agri GDP Share"  = "WB_nv_agr_totl_zs",
          "Agri Value Added (current US$)" = "WB_nv_agr_totl_cd",
          "Agri Value Added (constant 2010 US$)" = "WB_nv_agr_totl_kd",
          "GDP per capita (constant 2010 US$)" = "WB_ny_gdp_pcap_kd",

          "Agri Employment" = "WB_sl_agr_empl_zs",
          "Agri Female Employment" = "WB_sl_agr_empl_fe_zs",
          "Agri Male Employment" = "WB_sl_agr_empl_ma_zs",
          "pop-working-age" = "WB_sp_pop_1564_to_zs",
          "population" = "WB_sp_pop_totl",
          "pop-working-age-female" = "WB_sp_pop_1564_fe_in",
          "pop-working-age-male" = "WB_sp_pop_1564_ma_in",
          "pop-working-age2" = "WB_sp_pop_1564_to",

          "Agricultural Land" = "WB_ag_lnd_agri_k2",
          "Arable Land" = "WB_ag_lnd_arbl_ha",
          "Cereal yield" = "WB_ag_yld_crel_kg",
          "Irrigated Land" = "WB_ag_lnd_irig_ag_zs",
          "Irrigated Land2" = "QG_fao_luagrirrac"
        )

years <- c(1991, 2000, 2010, 2019)

cc_prod_data_all <- df_full %>%
    select(year, countrycode, regionname, adminregion, incomelevel, {{inds}}) %>%
    mutate(
           # agri_employ = `Agri Employment` * (`pop-working-age` * population),
           agri_employ = `Agri Employment`/100 * `pop-working-age2`,
           agri_prod = `Agri Value Added (constant 2010 US$)` / agri_employ,
           agri_fem_employ = `Agri Female Employment`/100 * `pop-working-age-female`,
           agri_male_employ = `Agri Male Employment`/100 * `pop-working-age-male`,

           va_per_hectare = `Agri Value Added (constant 2010 US$)` / `Arable Land`
    )

cc_prod_data <- cc_prod_data_all %>% filter(year %in% years)

cc_prod_data %>%
    ggplot(aes(x=log(`GDP per capita (constant 2010 US$)`), y=log(agri_prod), label=countrycode)) +
    geom_point(aes(color=(regionname == "South Asia"))) +
    geom_smooth(method='lm') +
    geom_point(data=filter(cc_prod_data, countrycode=="PAK"), shape=21, size=6) +
    facet_wrap(~year, ncol = 1) +
    scale_color_few(name = "Region", labels=c("Other", "South Asia")) +
    theme_few() + 
    labs(
         title = "Comparing Value Added per Worker in Agriculture",
         subtitle = "Pakistan circled",
         caption = "Source: World Bank"
    )

```

## How does Pakistans Value Added per Worker Change over Time?

While it has a relatively high level of value added per worker in agriculture, Pakistan has the slowest growth in value added per worker between 2000 and 2019 in South Asia. 

```{r}

cc_prod_data_all %>%
    filter(regionname == "South Asia") %>%
    filter(!is.na(agri_prod)) %>%
    filter(year == base_year) %>%
    ggplot(aes(x=reorder(countrycode, -agri_prod), y=agri_prod)) +
    geom_bar(stat="identity") + 
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill="orange", stat="identity") + 
    theme_few() +
    labs(
         title = "South Asian Value Added in Agriculture per Worker",
         subtitle = paste(base_year),
         y = "Value Added per Worker\n (constant 2010 US$)",
         x = "Country"
    )

cc_prod_data_all %>%
    filter(regionname == "South Asia") %>%
    filter(!is.na(agri_prod)) %>%
    filter(countrycode != "MDV") %>%
    ggplot(aes(x=year, y=agri_prod, color=countrycode, label=countrycode)) +
    geom_line() + 
    geom_text(data = . %>% filter(year == 2018), nudge_y=12, nudge_x = 2) +
    theme_few() +
    scale_color_few() +
    theme(legend.position = "none") + 
    labs(
         title = "South Asian Value Added in Agriculture per Worker over Time",
         y = "Value Added per Worker\n (constant 2010 US$)",
         x = "Year"
    )

```

```{r}

n_base_year <- 2000
target_year <- 2019

growth_dat <- cc_prod_data %>%
    group_by(countrycode) %>%
    arrange(year) %>%
    filter((year == n_base_year) | (year == target_year)) %>%
    mutate(
        growth = (lead(agri_prod) - agri_prod) / agri_prod * 100
    ) %>%
    filter(year == n_base_year) %>%
    filter(!is.na(growth))

growth_dat %>%
    filter(regionname == "South Asia") %>%
    ggplot(aes(x=reorder(countrycode, growth), y=growth)) +
    geom_bar(stat="identity") +
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill = "orange", stat="identity") +
    theme_few() + 
    theme(legend.position = "none") + 
    labs(
            title = paste("Growth in Value Added per Worker between ", n_base_year, "and", target_year),
            subtitle = "Agriculture in South Asia",
            x = "Country",
            y = "Value Added per Worker Growth (%)"
    )
```

```{r fig.width = 10, fig.height = 10}

# lets control for initial level of agri prod and gdp per capita 
# to see if we are at a predicted level of agri prod now given those two things 
# maybe we can also do this for agri share of gdp (but then we get into structural transformation
# territory)

# lets compare 2000 to 2019 
lag_diff <- 10 
regress_dat <- cc_prod_data_all %>%
    group_by(countrycode) %>%
    arrange(year) %>%
    mutate(
           prev_agri_prod = lag(agri_prod, lag_diff),
           growth = (agri_prod - prev_agri_prod) / prev_agri_prod * 100
    ) %>%
    ungroup() %>%
    mutate(
           l_agri_prod = log(prev_agri_prod),
           l_future_agri_prod = log(agri_prod),
           l_gdppc = log(`GDP per capita (constant 2010 US$)`),
    ) %>% 
    select(year, countrycode, l_gdppc, l_agri_prod, l_future_agri_prod, agri_share=`Agri GDP Share`, `Irrigated Land`)  %>%
    filter(!is.na(l_agri_prod) & !is.na(l_agri_prod) & !is.na(l_future_agri_prod)) 

regress_info <- regress_dat %>%
    group_by(year) %>%
    nest() %>%
    mutate(
           model = map(data, ~lm(l_future_agri_prod ~ l_gdppc + l_agri_prod + agri_share, .)),
           tidied = map(model, tidy)
    ) %>%
    unnest(tidied) %>%
    ungroup()

regress_coefs <- regress_info %>%
    select(year, term, estimate, model) %>%
    pivot_wider(names_from=term, names_prefix = "coef_", values_from=estimate)


# join this with pakistan per these years 
regress_dat %>% 
    left_join(regress_coefs, by="year") %>%
    filter(countrycode == "PAK") %>%
    mutate(
           predict_change = `coef_(Intercept)` + 
               coef_l_gdppc * l_gdppc + 
               coef_l_agri_prod * l_agri_prod +
               coef_agri_share * agri_share,
           residual = l_future_agri_prod - predict_change
    ) %>%
    ggplot(aes(x=year, y=residual)) +
    geom_bar(stat="identity") +
    theme_few() +
    labs(
         title = "Did Pakistans Agri Value Added per Worker Grow faster or Slower than Expected?",
         subtitle = paste("Prediction based on log gdp per capita, log agri productivity and agri share of GDP", lag_diff, "years prior")
    )

# regress_info %>%
#     select(year, term, `p.value`) %>%
#     pivot_wider(names_from=term, values_from=`p.value`) %>%
#     kable()

#    ggplot(aes(x=year, y=`p.value`, color=term)) +
#    geom_line() + 
#    geom_hline(yintercept = 0.1) +
#    geom_hline(yintercept = 0.05) +
#    theme_few() +
#    scale_color_few() + 
#    labs(
#         title = "Regression Coefficients over time"
#    )

```

## Decomposing Growth in Value Added per Worker

Value added per worker in agriculture is measured as gross output of the sector, minus intermediate costs, and divided by the number of people working in that sector. 

Is Pakistans low growth driven by slow growth in value add, or by fast growth in the labor pool, compared to other south asian countries?

Both. Pakistan had the slowest growth in total agriculture value add between 2000 and 2019 in South Asia. Additionally, Pakistan had the largest growth in total agriculture labor in all of South Asia. 

Decomposing the agriculture labor growth, we see that while both male and female labor growth is higher than comparators, female growth significantly outpaces male labor growth. 


```{r}

lag_diff <- 19 # so that we get 2019 vs 2000

decompose_data <- cc_prod_data_all %>%
    select(
           countrycode,
           regionname,
           year, 
           agri_prod, 
           agri_employ, 
           `Agri Value Added (constant 2010 US$)`,
           agri_fem_employ,
           agri_male_employ
    ) %>%
    group_by(countrycode) %>%
    arrange(year) %>%
    rename(agri_va = `Agri Value Added (constant 2010 US$)`) %>%
    mutate(
           prev_agri_prod = lag(agri_prod, lag_diff), 
           prev_agri_employ = lag(agri_employ, lag_diff),
           prev_agri_va = lag(agri_va, lag_diff),

           agri_prod_growth = (agri_prod - prev_agri_prod) / prev_agri_prod * 100,
           agri_employ_growth = (agri_employ - prev_agri_employ) / prev_agri_employ * 100,
           agri_va_growth = (agri_va - prev_agri_va) / prev_agri_va * 100,

           agri_prod_growth2 = ((1 + agri_va_growth) / (1 + agri_employ_growth)) - 1, # this matches

           prev_agri_male = lag(agri_male_employ, lag_diff),
           prev_agri_fem  = lag(agri_fem_employ, lag_diff),
           agri_male_growth = (agri_male_employ - prev_agri_male)/prev_agri_male * 100,
           agri_fem_growth  = (agri_fem_employ - prev_agri_fem)/prev_agri_fem * 100,
    ) %>%
    ungroup()

# lets compare labor growth rates in SA

decompose_data %>%
    filter(year == base_year) %>%
    filter(regionname == "South Asia") %>%
    filter(!is.na(agri_va_growth)) %>%
    ggplot(aes(x=reorder(countrycode, agri_va_growth), y=agri_va_growth)) + 
    geom_bar(stat="identity") +
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill="orange", stat="identity") +
    theme_few() +
    labs(
         title = paste("Percent growth in total agri value added between", base_year - lag_diff, "and", base_year),
         subtitle = "South Asia",
         y = "% growth in total agri value added in Agriculture\n (constant 2010 US$)",
         x = "Country"
    )


decompose_data %>%
    filter(year == base_year) %>%
    filter(regionname == "South Asia") %>%
    filter(!is.na(agri_va_growth)) %>%
    ggplot(aes(x=reorder(countrycode, -agri_employ_growth), y=agri_employ_growth)) + 
    geom_bar(stat="identity") +
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill="orange", stat="identity") +
    theme_few() +
    labs(
         title = paste("Percent growth in total labor employment between", base_year - lag_diff, "and", base_year),
         subtitle = "South Asia",
         y = "% growth in people employed in Agriculture",
         x = "Country"
    )

```
We can decompose the growth in labor between men and women. 

```{r}

decompose_data %>%
    filter(year == base_year) %>%
    filter(regionname == "South Asia") %>%
    filter(!is.na(agri_va_growth)) %>%
    ggplot(aes(x=reorder(countrycode, -agri_fem_growth), y=agri_fem_growth)) + 
    geom_bar(stat="identity") +
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill="orange", stat="identity") +
    theme_few() +
    labs(
         title = paste("Percent growth in female labor employment between", base_year - lag_diff, "and", base_year),
         subtitle = "South Asia",
         y = "% growth in females employed in Agriculture",
         x = "Country"
    )

decompose_data %>%
    filter(year == base_year) %>%
    filter(regionname == "South Asia") %>%
    filter(!is.na(agri_va_growth)) %>%
    ggplot(aes(x=reorder(countrycode, -agri_male_growth), y=agri_male_growth)) + 
    geom_bar(stat="identity") +
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill="orange", stat="identity") +
    theme_few() +
    labs(
         title = paste("Percent growth in male labor employment between", base_year - lag_diff, "and", base_year),
         subtitle = "Agriculture in South Asia",
         y = "% growth in males employed in Agriculture",
         x = "Country"
    )

```


```{r fig.height=10, fig.width=10}

# geom_bar(stat="identity", position="dodge") +

cc_prod_data_all %>%
    filter(regionname == "South Asia") %>%
    select(year, countrycode, agri_fem_employ, agri_male_employ) %>%
    pivot_longer(-c(year, countrycode)) %>%
    filter(!is.na(value)) %>%
    ggplot(aes(x=year, y=value, color=name)) +
    geom_line() +
    theme_few() +
    scale_color_few() +
    facet_wrap(~countrycode, scales = "free_y") + 
    labs(
         title = "Female vs Male Employment in Agriculture over Time",
         subtitle = "Agriculture in South Asia",
         y = "Population",
         x = "Year"
    )


```

## Value Added per Hectare of Arable Land

In the world, Pakistan has roughly expected levels of Value Added per Hectare of Arable land for its level of GDP per capita. 

However, the next figure shows that Pakistan has the lowest value added per hectare of arable land in all of South Asia, bar Afghanistan. 

Growth has also been slow, and it has only been faster than Sri Lanka. Sri Lanka has had a greater growth in value added over this time period, and has slower growth in this metric due to a 40% increase in the amount of Arable land over the period. 


```{r fig.width = 10, fig.height = 10}

cc_prod_data_all %>%
    filter(year %in% c(1991, 2000, 2010, 2016)) %>%
    ggplot(aes(
               x=log(`GDP per capita (constant 2010 US$)`), 
               y=log(va_per_hectare), 
               label=countrycode)) +
    geom_point(aes(color=(regionname == "South Asia"))) +
    geom_smooth(method='lm') +
    geom_point(data=. %>% filter(countrycode=="PAK"), shape=21, size=6) +
    facet_wrap(~year, ncol = 1) +
    scale_color_few(name = "Region", labels=c("Other", "South Asia")) +
    theme_few() + 
    labs(
         title = "Comparing Agricultural Value Added per Hectare of Arable Land",
         subtitle = "Pakistan circled",
         caption = "Source: World Bank"
    )

```

```{r}

cc_prod_data_all %>%
    filter(regionname == "South Asia") %>%
    filter(countrycode != "MDV") %>%
    ggplot(aes(x=year, y=va_per_hectare, color=countrycode, label=countrycode)) +
    geom_line() +
    geom_text(data =. %>% filter(year == 2016), nudge_x = 2) +
    theme_few() +
    theme(legend.position = "none") + 
    labs(
         title = "Agriculture Value Added per Hectare of Arable Land",
         subtitle = "South Asia",
         y = "Agricultural Value Added (Constant 2010 US$)\n per Hectare of Arable Land",
         x = "Year"
    )

cc_prod_data_all %>%
    filter(regionname == "South Asia") %>%
    filter(countrycode != "MDV") %>%
    filter(year == 2016) %>%
    ggplot(aes(x=reorder(countrycode, va_per_hectare), y=va_per_hectare)) +
    geom_bar(stat="identity") +
    geom_bar(data=. %>% filter(countrycode == "PAK"), fill="orange", stat="identity") +
    theme_few() +
    labs(
         title = "Agriculture Value Added per Hectare of Arable Land",
         subtitle = "South Asia",
         y = "Agricultural Value Added (Constant 2010 US$)\n per Hectare of Arable Land",
         x = "Country"
    )

lag_diff <- 16
decompose_hectare_df <- cc_prod_data_all %>%
    group_by(countrycode) %>%
    arrange(year) %>%
    mutate(
           prev_arable_land = lag(`Arable Land`, lag_diff),
           arable_land_change = (`Arable Land` - prev_arable_land)/prev_arable_land * 100,

           prev_va_per_hectare = lag(va_per_hectare, lag_diff),
           va_per_hectare_growth = (va_per_hectare - prev_va_per_hectare)/prev_va_per_hectare * 100
    ) %>%
    ungroup()

decompose_hectare_df %>%
    filter(regionname == "South Asia") %>%
    filter(year == 2016) %>%
    filter(!is.na(va_per_hectare_growth)) %>%
    ggplot(aes(x=reorder(countrycode, va_per_hectare_growth), y=va_per_hectare_growth)) +
    geom_bar(stat="identity") +
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill="orange", stat="identity") +
    theme_few() + 
    labs(
         title = paste("Value Added per Hectare"),
         subtitle = paste("Growth between 2016 and", 2016-lag_diff),
         x = "Country",
         y = "% Growth in Value Added per Hectare of Arable Land \n (constant 2010 US$ / ha)"
    )

decompose_hectare_df %>%
    filter(regionname == "South Asia") %>%
    filter(year == 2016) %>%
    filter(!is.na(va_per_hectare_growth)) %>%
    ggplot(aes(x=reorder(countrycode, arable_land_change), y=arable_land_change)) +
    geom_bar(stat="identity") +
    geom_bar(data = . %>% filter(countrycode == "PAK"), fill="orange", stat="identity") +
    theme_few() + 
    labs(
         title = paste("Growth in Arable Land between 2016 and", 2016-lag_diff),
         x = "Country",
         y = "% Growth in Arable Land"
    )

```

## Next Steps

We have seen that both the value added growth is slower than comparators, and that L is increasing much faster than comparators. 

There is significant room to increase the value added in agriculture. And this may be the problem to fixate on for now. Even with all these extra workers, who maybe cannot find a job in the industrial sector, we cannot boost the value added. Even if an 'average' number of people instead had shifted to work in industry, the value added would be lower compared to other countries. 

We see that Pakistan has the least productive land in South Asia, other than Afghanistan. Is this true at a subnational level as well? Why is it so unproductive? Can we get variation in district-level land productivity? What drives that variation? 

Is Pakistan growing the wrong crops? Maybe the quantity being produced on the land is actually growing over time, but the prices are falling. For some reason, farmers are not switching to better crops. Todo: rule out a price effect so that we can focus on quantity questions.

Are people using the wrong mix of inputs, driving lower quantities? Can we see this at a macro level?

Are intermediate costs rising for some reason, far more than in other countries? What are the intermediate costs? How does FAO / the world bank take them out?

Other notes: 

According to this data, there are almost 2x as many women working in agriculture than men. I am curious what this actually means - do they only do particular jobs, work on particular crops? Maybe interventions need to target increasing the productivity of women in Agriculture. 


## Gross Crop Production Patterns

```{r}

lag_diff <- 16 # so that we get 2016 vs 2000
gross_vs_va <- global_agri_data %>%
    filter(Element == "Gross Production Value (constant 2014-2016 thousand US$)") %>%
    group_by(countrycode, year) %>%
    summarise(
              gross_production_1416_usd = sum(Value * 1000)
    ) %>%
    right_join(cc_prod_data_all, by=c("countrycode", "year")) %>%
    group_by(countrycode) %>%
    arrange(year) %>%
    mutate(
           gross_prod_per_ha = gross_production_1416_usd / `Arable Land`,

           prev_gross_prod = lag(gross_production_1416_usd, lag_diff),
           prev_gross_prod_per_ha = lag(gross_prod_per_ha, lag_diff),

           gross_prod_growth = (gross_production_1416_usd - prev_gross_prod)/prev_gross_prod * 100,
           gross_prod_per_ha_growth = (gross_prod_per_ha - prev_gross_prod_per_ha)/prev_gross_prod_per_ha * 100
    ) %>%
    ungroup()

gross_vs_va %>%
    filter(regionname == "South Asia") %>%
    filter(year == 2016) %>%
    ggplot(aes(x=reorder(countrycode, gross_prod_growth), y=gross_prod_growth)) +
    geom_bar(stat="identity") +
    geom_bar(data= . %>% filter(countrycode == "PAK"), fill="orange", stat="identity")+ 
    theme_few() +
    labs(
         title = "% Growth of Gross Crop Production (constant 2014-2016 US$)",
         subtitle = "South Asia, 2000-2016",
         x = "Country",
         y = "% Growth of Gross Production Value of Crops"
    )

names(gross_vs_va)
# we have gross production per acre of land. 
# how much of gross production is because of kg difference in a crop 
# how much because of price difference?
# this will have to be done by crop...

gross_vs_va %>%
    filter(regionname == "South Asia") %>%
    filter(year == 2016) %>%
    ggplot(aes(x=reorder(countrycode, gross_prod_per_ha), y=gross_prod_per_ha)) +
    geom_bar(stat="identity") +
    geom_bar(data= . %>% filter(countrycode == "PAK"), fill="orange", stat="identity")+ 
    theme_few() +
    labs(
         title = "Gross Crop Production (2014-2016 constant USD)\nper Hectare of Arable Land",
         subtitle = "South Asia, 2016",
         x = "Country",
         y = "Gross Production Value (constant 2014-2016 USD) of Crops \n per Hectare of Arable Land"
    )

gross_vs_va %>%
    filter(regionname == "South Asia") %>%
    filter(year == 2016) %>%
    ggplot(aes(x=reorder(countrycode, gross_prod_per_ha_growth), y=gross_prod_per_ha_growth)) +
    geom_bar(stat="identity") +
    geom_bar(data= . %>% filter(countrycode == "PAK"), fill="orange", stat="identity")+ 
    theme_few() +
    labs(
         title = "% Growth of Gross Crop Production per Hectare of Arable Land",
         subtitle = "South Asia, 2000-2016",
         x = "Country",
         y = "% Growth of Gross Production Value of Crops \n per Hectare of Arable Land"
    )

```

The crop data confirms that just looking at crop production, Pakistan is low gross output for its level of arable land. Growth is also not great. 

Now, we can start to look at per crop, the land allocated to it, and the money squeezed out. We should look at things like the concentration of crops in each. The top n crops for Pakistan, how has their production per hectare changed over this time period? How does that relate to others in South Asia?

For each crop, how much of the growth was driven by price changes? Each crop has gross production, change in land, change in price. 

```{r fig.width=10, fig.height=10}

# main crops by production value for south asian countries?

global_crop_shares <- global_agri_wide %>%
    filter(!is.na(`Area harvested`)) %>%
    filter(!is.na(`Gross Production Value`)) %>%
    group_by(countrycode, year) %>%
    arrange(-`Gross Production Value`) %>%
    mutate(
           prod_share = `Gross Production Value` / sum(`Gross Production Value`),
           area_share = `Area harvested` / sum(`Area harvested`)
    ) %>%
    ungroup()

global_crop_shares %>%
    filter(year == base_year) %>%
    filter(countrycode == "PAK") %>%
    arrange(-prod_share) %>%
    mutate(
           position = row_number() 
    ) %>%
    filter(prod_share > 0.002) %>%
    select(countrycode, Item, position, area_share, prod_share) %>%
    pivot_longer(-c("countrycode", "Item", "position")) %>%
    ggplot(aes(x=reorder(Item, position), y=value, fill=name)) +
    geom_bar(stat="identity", position="dodge") +
    theme_few() +
    labs(
         title = "Area and Production share for crops in Pakistan",
         subtitle = paste("Year:", base_year),
         caption = "Source: FAOSTAT",
         x = "Crop",
         y = "Share of Total"
    ) +
    theme(axis.text.x = element_text(angle = 45, vjust=0.9))

```


```{r fig.width=10}

# price vs kg changes per crop in Pakistan

lag_diff <- 19 # to get 2019 - 2000 comparison

global_crop_changes <- global_crop_shares %>%
    group_by(countrycode, Item) %>%
    arrange(year) %>%
    mutate(
           prev_area = lag(`Area harvested`, lag_diff),
           prev_yield = lag(Yield, lag_diff),
           prev_prod = lag(Production, lag_diff),
           prev_prod_val = lag(`Gross Production Value`, lag_diff),
           prev_prod_share = lag(prod_share, lag_diff),
           prev_area_share = lag(area_share, lag_diff),
           prev_price = lag(price, lag_diff),
           prev_econ_yield = lag(econ_yield, lag_diff),

           prod_growth = (Production - prev_prod)/prev_prod * 100,
           prod_val_growth = (`Gross Production Value` - prev_prod_val)/prev_prod_val * 100,
           area_growth = (`Area harvested` - prev_area) / prev_area * 100,
           prod_share_growth = (prod_share - prev_prod_share)/prev_prod_share * 100,
           area_share_growth = (area_share - prev_area_share)/prev_area_share * 100,
           price_growth = (price - prev_price)/prev_price * 100,
           yield_growth = (Yield - prev_yield)/prev_yield * 100,
           econ_yield_growth = (econ_yield - prev_econ_yield) / prev_econ_yield * 100
    )

global_crop_changes %>%
    filter(countrycode == "PAK") %>%
    filter(year == base_year) %>%
    pivot_longer(c("price_growth", "prod_growth")) %>%
    mutate(Item = str_trunc(Item, 10)) %>%
    ggplot(aes(x=reorder(Item, -area_share), y=value, fill=name)) +
    geom_bar(stat="identity", position="dodge") +
    theme_few() +
    theme(axis.text.x = element_text(angle = 45, vjust=0.9))

global_crop_changes %>%
    filter(countrycode == "PAK") %>%
    filter(year == base_year) %>%
    mutate(Item = str_trunc(Item, 10)) %>%
    ggplot(aes(x=reorder(Item, -area_growth), y=area_growth)) +
    geom_bar(stat="identity", position="dodge") +
    theme_few() +
    theme(axis.text.x = element_text(angle = 45, vjust=0.9)) +
    labs(
         title = "Growth in Area Harvested per Crop",
         subtitle = paste("Between", base_year - lag_diff, "and", base_year),
         x = "Item",
         y = "% Growth"
    )

global_crop_changes %>%
    filter(countrycode == "PAK") %>%
    filter(year == base_year) %>%
    mutate(Item = str_trunc(Item, 10)) %>%
    ggplot(aes(x=reorder(Item, -prod_growth), y=prod_growth)) +
    geom_bar(stat="identity", position="dodge") +
    theme_few() +
    theme(axis.text.x = element_text(angle = 45, vjust=0.9)) +
    labs(
         title = "Growth in Production per Crop (KG)",
         subtitle = paste("Between", base_year - lag_diff, "and", base_year),
         x = "Item",
         y = "% Growth"
    )

global_crop_changes %>%
    filter(countrycode == "PAK") %>%
    filter(year == base_year) %>%
    mutate(Item = str_trunc(Item, 10)) %>%
    ggplot(aes(x=reorder(Item, -yield_growth), y=yield_growth)) +
    geom_bar(stat="identity", position="dodge") +
    theme_few() +
    theme(axis.text.x = element_text(angle = 45, vjust=0.9)) +
    labs(
         title = "Growth in Yield per Crop (KG/Ha)",
         subtitle = paste("Between", base_year - lag_diff, "and", base_year),
         x = "Item",
         y = "% Growth"
    )

global_crop_changes %>%
    filter(countrycode == "PAK") %>%
    filter(year == base_year) %>%
    mutate( price_change = abs(price_growth)) %>%
    mutate(Item = str_trunc(Item, 10)) %>%
    ggplot(aes(x=reorder(Item, -price_change), y=price_growth)) +
    geom_bar(stat="identity") +
    theme_few() +
    theme(axis.text.x = element_text(angle = 45, vjust=0.9)) +
    labs(
         title = "Price changes for crops in Pakistan",
         y = "Price Growth (%)",
         x = "Item"
    )
# in the crops which make up the major share of production
# how has value changed with price 
```

```{r fig.height=10, fig.width=10}

global_crop_changes %>%
    filter(countrycode %in% comparators) %>%
    filter(year == base_year) %>%
    group_by(countrycode) %>%
    arrange(-prev_prod_share) %>%
    mutate(position = row_number()) %>%
    ungroup() %>%
    mutate(Item = str_trunc(Item, 10)) %>%
    ggplot(aes(x=position, y=yield_growth, fill=prod_share)) +
    geom_bar(stat="identity", position="dodge") +
    theme_few() +
    scale_fill_viridis_b() +
    facet_wrap(~countrycode) +
    theme(axis.text.x = element_text(angle = 45, vjust=0.9)) +
    labs(
         title = "Growth in Yield per Crop (KG/Ha)",
         subtitle = paste("Between", base_year - lag_diff, "and", base_year),
         x = "Rank of how important this crop used to be",
         y = "% Growth"
    )

```

```{r}

# I want first, biggest change in prod share 

crop_changes_table <- global_crop_changes %>%
    filter(countrycode %in% comparators) %>%
    filter(year == base_year) %>%
    group_by(countrycode) %>%
    arrange(-prod_share) %>%
    mutate(position = row_number()) %>%
    ungroup() %>%
    group_by(Item) %>%
    mutate(
           avg_yield_growth = median(yield_growth, na.rm = T),
           avg_price = median(price),
           rel_price = price / avg_price
    ) %>%
    ungroup() %>%
    filter(countrycode == "PAK") %>%
    filter(prod_share > 0.01) %>%
    arrange(-prod_share_growth) %>%
    mutate(
           prod_share = prod_share * 100,
           area_share = area_share * 100 
    )

crop_changes_table %>%
    select(
           Item, 
           "Production Ranking"=position,
           "Prod Share"=prod_share,
           "Area Share"=area_share, 
           "Prod Share Growth"=prod_share_growth, 
           "Area Share Growth"=area_share_growth, 
           "Yield Growth"=yield_growth,
           "Avg Yield Growth" = avg_yield_growth,
           "Rel Price" = rel_price,
           "Econ Yield Growth"=econ_yield_growth,
           "Prod Growth"=prod_val_growth,
           "Area Growth"=area_growth
    ) %>% 
    kable(digits = 1)

```

Lets look at prices of crops relative to others.

```{r fig.height=10, fig.width=10}

# no variation in time really. ok to show a time slice

global_crop_changes %>%
    filter(countrycode %in% comparators) %>%
    filter(Item %in% crop_changes_table$Item) %>%
    filter(year == base_year) %>%
    ggplot(aes(y=price, x=Item, label=countrycode)) +
    geom_boxplot() +
    geom_text(alpha = 0.1) + 
    geom_point(data = . %>% filter(countrycode == "PAK"), color = "orange") +
    theme_few() + 
    facet_wrap(~Item, scales="free") + 
    labs(
         title = "Pakistans Place in Price Distribution for Major Crops",
         subtitle = base_year
    )

global_crop_changes %>%
    filter(countrycode %in% comparators) %>%
    filter(Item %in% crop_changes_table$Item) %>%
    filter(year == base_year) %>%
    ggplot(aes(y=Yield, x=Item, label=countrycode)) +
    geom_boxplot() +
    geom_text(alpha = 0.1) + 
    geom_point(data = . %>% filter(countrycode == "PAK"), color = "orange") +
    theme_few() + 
    facet_wrap(~Item, scales="free") + 
    labs(
         title = "Pakistans Place in Yield Distribution for Major Crops",
         subtitle = base_year
    )

global_crop_changes %>%
    filter(countrycode %in% comparators) %>%
    filter(year == base_year) %>%
    group_by(Item) %>%
    mutate(
           rel_yield = Yield / mean(Yield, na.rm = T),
           rel_price = price / mean(price, na.rm = T)
    ) %>%
    ungroup() %>%
    filter(countrycode == "PAK") %>%
    filter(prod_share > 0.005) %>%
    ggplot(aes(x=rel_price, y=rel_yield, color=`prod_share`)) +
    geom_vline(xintercept = 1, linetype = "dashed") +
    geom_hline(yintercept = 1, linetype = "dashed") +
    geom_point(aes(size=`Area harvested`)) +
    geom_text(aes(label=Item), nudge_y = -0.015) +
    theme_few() + 
    labs(
         title = "Relative Yield vs Relative Price",
         subtitle = "Pakistan Comparison vs Comparator countries",
         y = "Yield Relative to Mean Yield",
         x = "Price Relative to Mean Price"
    )

global_crop_changes %>%
    filter(countrycode %in% comparators) %>%
    filter(year == base_year) %>%
    group_by(Item) %>%
    mutate(
           rel_yield = Yield / median(Yield, na.rm = T),
           rel_price = price / median(price, na.rm = T)
    ) %>%
    ungroup() %>%
    filter(countrycode == "PAK") %>%
    filter(prod_share > 0.005) %>%
    ggplot(aes(x=rel_price, y=rel_yield, color=`prod_share`)) +
    geom_vline(xintercept = 1, linetype = "dashed") +
    geom_hline(yintercept = 1, linetype = "dashed") +
    geom_point(aes(size=`Area harvested`)) +
    geom_text(aes(label=Item), nudge_y = -0.015) +
    theme_few() + 
    labs(
         title = "Relative Yield vs Relative Price",
         subtitle = "Pakistan Comparison vs Comparator countries",
         y = "Yield Relative to Median Yield",
         x = "Price Relative to Median Price"
    )

# shows path over time 
global_crop_changes %>%
    filter(countrycode %in% comparators) %>%
    filter(year > 2000) %>%
    # filter(Item %in% crop_changes_table$Item) %>%
    group_by(year, Item) %>%
    mutate(
           rel_yield = Yield / median(Yield, na.rm = T),
           rel_price = price / median(price, na.rm = T)
    ) %>%
    ungroup() %>%
    arrange(year) %>%
    filter(countrycode == "PAK") %>%
    filter(prod_share > 0.01) %>%
    ggplot(aes(x=rel_price, y=rel_yield, color=`prod_share`)) +
    geom_vline(xintercept = 1, linetype = "dashed") +
    geom_hline(yintercept = 1, linetype = "dashed") +
    geom_point(data = . %>% filter(year == base_year), aes(size=`Area harvested`)) +
    geom_text(data = . %>% filter(year == base_year), aes(label=str_trunc(Item, 10)), nudge_y = -0.015, nudge_x = 0.025) +
    geom_path(data = . %>% filter(rel_price < 1.5), aes(group = Item), alpha = 0.5) +
    geom_text(data = . %>% filter(rel_price < 1.5), aes(label=year), alpha = 0.2) +
    theme_few() + 
    labs(
         title = "Relative Yield vs Relative Price",
         subtitle = "Comparison vs Comparator countries",
         y = "Yield Relative to Median Yield",
         x = "Price Relative to Median Price"
    )

# vs world
global_crop_changes %>%
    filter(year == base_year) %>%
    group_by(Item) %>%
    mutate(
           rel_yield = Yield / median(Yield, na.rm = T),
           rel_price = price / median(price, na.rm = T)
    ) %>%
    ungroup() %>%
    filter(countrycode == "PAK") %>%
    filter(prod_share > 0.005) %>%
    ggplot(aes(x=rel_price, y=rel_yield, color=`prod_share`)) +
    geom_vline(xintercept = 1, linetype = "dashed") +
    geom_hline(yintercept = 1, linetype = "dashed") +
    geom_point(aes(size=`Area harvested`)) +
    geom_text(aes(label=Item), nudge_y = -0.015) +
    theme_few() + 
    labs(
         title = "Relative Yield vs Relative Price",
         subtitle = "Comparison vs World",
         y = "Yield Relative to Median Yield",
         x = "Price Relative to Median Price"
    )

```




# Appendix

Below I got curious about the relationship between concentration in crops

```{r fig.width=10, fig.height=10}
# theme(axis.text.x = element_text(angle = 45, vjust=0.9)) +
# reorder(Item, position)
global_crop_shares %>%
    filter(year == base_year) %>%
    group_by(countrycode) %>%
    arrange(-prod_share) %>%
    mutate(
           position = row_number() 
    ) %>%
    filter(countrycode %in% comparators) %>%
    filter(prod_share > 0.01) %>%
    select(countrycode, Item, position, area_share, prod_share) %>%
    pivot_longer(-c("countrycode", "Item", "position")) %>%
    ggplot(aes(x=position, y=value, fill=name)) +
    geom_bar(stat="identity", position="dodge") +
    theme_few() +
    labs(
         title = "Area and Production share for crops in South Asia",
         subtitle = paste("Year:", base_year),
         caption = "Source: FAOSTAT"
    ) +
    facet_wrap(~countrycode)

global_crop_concentrations <- global_crop_shares %>%
    group_by(countrycode, year) %>%
    summarise(
              area_concentration = sum((area_share*100)^2),
              prod_concentration = sum((prod_share*100)^2)
              # mismatches = sum((area_share - prod_share)^2)
    ) %>%
    ungroup()

global_crop_concentrations %>%
    filter(countrycode %in% comparators) %>%
    pivot_longer(-c(year, countrycode)) %>%
    ggplot(aes(x=year, y=value, color=name)) +
    geom_line() +
    theme_few() + 
    facet_wrap(~countrycode, scales = "free_y" ) +
    labs(
         title = "South Asian Crop and Area concentration over Time",
         y = "HHI",
         x = "Year"
    )

# global_crop_concentrations %>%
#     left_join(cc_prod_data_all) %>%
#     filter(year == base_year) %>%
#     ggplot(aes(x=log(`GDP per capita (constant 2010 US$)`), y=mismatches, label=countrycode)) +
#     geom_text() +
#     theme_few()

```

